version: '3.9'

services:
  backend-core:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: backend-core-dokploy
    ports:
      - "8989:8989"
    environment:
      # Database configuration
      SPRING_DATASOURCE_URL: jdbc:postgresql://devflow-naverhackathon-hggsje:5432/naver_hackathon
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: "12345"
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.postgresql.Driver
      
      # Redis configuration
      SPRING_REDIS_HOST: devflow-naverhackathon-ueemyy
      SPRING_REDIS_PORT: 6379
      SPRING_REDIS_PASSWORD: tqybmepkxzyvrb70
      SPRING_REDIS_USERNAME: default
      
      # JPA/Hibernate
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: "false"
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.PostgreSQLDialect
      SPRING_JPA_OPEN_IN_VIEW: "false"
      
      # Server
      SERVER_PORT: 8989
      SPRING_PROFILES_ACTIVE: production
      
      # Clerk Authentication (cần cấu hình trong Dokploy)
      CLERK_JWKS_URL: ${CLERK_JWKS_URL:-https://direct-newt-10.clerk.accounts.dev/.well-known/jwks.json}
      CLERK_ISSUER: ${CLERK_ISSUER:-https://direct-newt-10.clerk.accounts.dev}
      CLERK_AUDIENCE: ${CLERK_AUDIENCE:-}
      
      # Gemini AI (optional)
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      
      # Logging
      LOGGING_LEVEL_COM_NAAMMM_BECORE: INFO
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB: INFO
      
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8989/api/tasks || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
