version: '3.8'

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.2
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - bootstrap.memory_lock=true
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  backend-core:
    build: .
    container_name: backend-core
    ports:
      - "8989:8989"
    # Thêm extra_hosts để resolve hostname của PostgreSQL (nếu cần)
    # extra_hosts:
    #   - "devflow-naverhackathon-hggsje:<postgres-ip>"
    environment:
      # Database configuration - dùng external IP
      - SPRING_DATASOURCE_URL=jdbc:postgresql://110.234.195.193:5432/naver_hackathon?sslmode=disable&connectTimeout=10
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=12345
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver
      
      # Redis configuration - dùng external IP
      - REDIS_HOST=110.234.195.193
      - REDIS_PORT=6379
      - SPRING_REDIS_PASSWORD=tqybmepkxzyvrb70
      - SPRING_REDIS_URL=redis://default:tqybmepkxzyvrb70@110.234.195.193:6379
      
      # Elasticsearch configuration - dùng service name
      - SPRING_ELASTICSEARCH_URIS=http://elasticsearch:9200
      
      # Clerk và Gemini
      - CLERK_JWKS_URL=https://direct-newt-10.clerk.accounts.dev/.well-known/jwks.json
      - CLERK_ISSUER=https://direct-newt-10.clerk.accounts.dev
      # GEMINI_API_KEY must be set via Dokploy environment variables
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      
      # Production settings
      - SPRING_PROFILES_ACTIVE=production
      - SPRING_JPA_SHOW_SQL=false
      - LOGGING_LEVEL_COM_NAAMMM_BECORE=INFO
      - LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB=INFO
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - app-network  # Network cho Elasticsearch
    # Trên Dokploy, các services thường tự động trong cùng network
    # Nếu vẫn không kết nối được PostgreSQL, thử dùng IP thay vì hostname
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8989/api/tasks || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

volumes:
  es_data:
    driver: local

networks:
  app-network:
    driver: bridge
  # Kết nối với network của Dokploy để access PostgreSQL và Redis
  # Tên network có thể là: dokploy-network, dokploy_default, hoặc tên project
  dokploy-network:
    external: true
    name: dokploy-network  # Thử các tên: dokploy-network, dokploy_default, hoặc tìm bằng: docker network ls | grep dokploy

